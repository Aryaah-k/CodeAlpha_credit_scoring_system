{% extends 'credit_app/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Apply for Credit{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-file-alt"></i> Credit Application Form</h4>
            </div>
            <div class="card-body">
                {% if form.errors %}
                <div class="alert alert-danger">
                    <h5>Please correct the following errors:</h5>
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li>{{ field.label }}: {{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                <form method="post" id="creditApplicationForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2">Personal Information</h5>
                            {{ form.age|as_crispy_field }}
                            {{ form.annual_income|as_crispy_field }}
                            {{ form.monthly_debt|as_crispy_field }}
                            {{ form.employment_status|as_crispy_field }}
                            {{ form.education_level|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2">Credit Information</h5>
                            {{ form.credit_score|as_crispy_field }}
                            {{ form.number_of_credit_lines|as_crispy_field }}
                            {{ form.credit_card_limit|as_crispy_field }}
                            {{ form.credit_card_balance|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2">Loan Details</h5>
                            {{ form.loan_amount|as_crispy_field }}
                            {{ form.loan_purpose|as_crispy_field }}
                            {{ form.loan_term_months|as_crispy_field }}
                            {{ form.interest_rate|as_crispy_field }}
                        </div>
                        
                        <div class="col-md-6">
                            <h5 class="border-bottom pb-2">Payment History</h5>
                            {{ form.late_payments_30days|as_crispy_field }}
                            {{ form.late_payments_60days|as_crispy_field }}
                            {{ form.late_payments_90days|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button type="submit" class="btn btn-primary btn-lg w-100">
                            <i class="fas fa-paper-plane"></i> Submit Application
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> Application Tips</h5>
            </div>
            <div class="card-body">
                <ul>
                    <li>Ensure all information is accurate and up-to-date</li>
                    <li>Higher income and lower debt improve approval chances</li>
                    <li>Maintain a good payment history with minimal late payments</li>
                    <li>Keep credit utilization below 30% for better scores</li>
                    <li>Longer employment history positively impacts scoring</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
    // Real-time calculation of debt-to-income ratio
    document.getElementById('id_annual_income').addEventListener('input', calculateDTI);
    document.getElementById('id_monthly_debt').addEventListener('input', calculateDTI);
    
    function calculateDTI() {
        const income = parseFloat(document.getElementById('id_annual_income').value) || 0;
        const debt = parseFloat(document.getElementById('id_monthly_debt').value) || 0;
        
        if (income > 0) {
            const dti = (debt * 12 / income) * 100;
            const dtiElement = document.getElementById('dti-display');
            if (!dtiElement) {
                const div = document.createElement('div');
                div.id = 'dti-display';
                div.className = 'alert alert-info mt-2';
                document.getElementById('id_monthly_debt').parentNode.appendChild(div);
            }
            document.getElementById('dti-display').innerHTML = 
                `<strong>Debt-to-Income Ratio:</strong> ${dti.toFixed(1)}% ` +
                `<small>(${dti < 36 ? 'Good' : dti < 43 ? 'Acceptable' : 'High'})</small>`;
        }
    }
</script>
{% endblock %}